name: Pipeline
run-name: Deploy in live by ${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual execution)'
        required: false
        type: boolean
        default: false
      drop_collections:
        description: 'Drop existing collections before import'
        required: false
        type: boolean
        default: true
  push:
    branches:
      - main

jobs:
  job1:
    environment: ${{ github.ref_name == 'main' && 'production' || 'develop' }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate Triple Conditional Logic
        if: ${{ !inputs.dry_run }}
        run: |
          echo "=== Validación de Condicionales ==="
          echo "🔍 dry_run value: ${{ inputs.dry_run }}"
          echo "🔍 not dry_run value: ${{ !inputs.dry_run }}"
          echo "🔍 drop_collections value: ${{ inputs.drop_collections }}"
          echo "🔍 not drop_collections value: ${{ !inputs.drop_collections }}"
          echo "🔍 github.event_name  value: ${{ github.event_name  }}"
          echo ""
          
          DATA_DIR="data/Product System Data Database"
          echo "📁 Data directory: $DATA_DIR"
          echo ""
          
          # if drop_collections is true or github.event_name is push, then add --drop-collections, otherwise add --no-drop-collections
          echo "➡️  Comando simulado: python3 scripts/system_database_setup/import_mongodb_data.py \
              --data-dir '$DATA_DIR' \
              ${{ (inputs.drop_collections || github.event_name == 'push') && '-' || '--no' }}-drop-collections"
          
          echo "================================================"
          echo "✅ Mode: Live Import"
          echo "${{ inputs.drop_collections && '🔄 Strategy: Zero-downtime drop-and-reload' || '📝 Strategy: Legacy upsert (no drop)' }}"