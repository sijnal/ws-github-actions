name: Pipeline
run-name: Deploy in live by ${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual execution)'
        required: false
        type: boolean
        default: false
      drop_collections:
        description: 'Drop existing collections before import'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main

jobs:
  job1:
    environment: ${{ github.ref_name == 'main' && 'production' || 'develop' }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate Triple Conditional Logic
        if: ${{ !inputs.dry_run }}
        run: |
          echo "=== Validaci√≥n de Condicionales ==="
          echo "üîç dry_run value: ${{ inputs.dry_run }}"
          echo "üîç not dry_run value: ${{ !inputs.dry_run }}"
          echo "üîç drop_collections value: ${{ inputs.drop_collections }}"
          echo "üîç not drop_collections value: ${{ !inputs.drop_collections }}"
          echo "üîç github.event_name  value: ${{ github.event_name  }}"
          echo ""
          
          DATA_DIR="data/Product System Data Database"
          echo "üìÅ Data directory: $DATA_DIR"
          echo ""
          
          echo "‚û°Ô∏è  Comando simulado: python3 scripts/system_database_setup/import_mongodb_data.py --data-dir '$DATA_DIR'  ${{ !inputs.drop_collections && '--no' || '-' }}-drop-collections"
          
          echo "================================================"

          if [ "${{ github.event_name  }}" = "push" ]; then
            echo "üîÑ Automatic import: Using zero-downtime drop-and-reload strategy"
            echo "‚û°Ô∏è  Comando simulado: python3 scripts/system_database_setup/import_mongodb_data.py --data-dir '$DATA_DIR' --drop-collections"
          elif [ "${{ inputs.drop_collections }}" = "false" ]; then
            echo "üìù Manual import: Using legacy upsert strategy (--no-drop-collections)"
            echo "‚û°Ô∏è  Comando simulado: python3 scripts/system_database_setup/import_mongodb_data.py --data-dir '$DATA_DIR' --no-drop-collections"
          else
            echo "üîÑ Manual import: Using zero-downtime drop-and-reload strategy"
            echo "‚û°Ô∏è  Comando simulado: python3 scripts/system_database_setup/import_mongodb_data.py --data-dir '$DATA_DIR' --drop-collections"
          fi
